<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>Manajemen Jaringan</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/socket-handler.js"></script>
    <style>
        .network-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }

        .node-form {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .node-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .node-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
            /* Default: abu-abu */
        }

        .status-dot.online {
            background: #4CAF50;
        }

        .status-dot.offline {
            background: #FF5722;
        }
    </style>
    <!-- Include the shared socket handler first -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/socket-handler.js"></script>
</head>

<body>
    <nav aria-label="Main navigation">
        <div class="logo">BlockDoc</div>
        <div class="nav-menu">
            <a href="/">Home</a>
            <a href="/documents">Dokumen</a>
            <a href="/verify">Verifikasi</a>
            <a href="/network">Jaringan</a>
        </div>
    </nav>

    <header>
        <div class="header-content">
            <h1>Manajemen Node Jaringan</h1>
        </div>
    </header>

    <div class="container">
        <h2>Tambah Node Baru</h2>
        <div class="card">
            <div class="form-group">
                <input type="text" id="nodeUrl" placeholder="http://ip:port">
                <button style="margin-top: 30px;" class="btn btn-verify" onclick="registerNode()">Tambahkan
                    Node</button>
            </div>
            <h2>Daftar Node Terhubung</h2>
            <div id="nodes">
                <!-- Template node item -->
                <div class="node-item">
                    <span class="node-url"></span>
                    <span class="status-dot"></span>
                </div>
            </div>
        </div>
        <div id="connection-status"></div>
    </div>

    <script>

        // network.html - Tambah fungsi ini
        function showErrorToast(message) {
            Toastify({
                text: message,
                duration: 3000,
                backgroundColor: "linear-gradient(to right, #ff416c, #ff4b2b)",
            }).showToast();
        }

        function showSuccessToast(message) {
            Toastify({
                text: message,
                duration: 3000,
                backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
            }).showToast();
        }

        // Panggil saat registrasi berhasil
        socket.on('node_registered', (url) => {
            showSuccessToast(`Node ${url} berhasil ditambahkan!`);
        });

        let currentNode = '';

        // Use the shared socket connection
        const socket = window.appSocket;

        // Show connection status
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connection-status');
            if (socket.connected) {
                statusElement.innerHTML = '<p style="color: green;">Status: Terhubung</p>';
            } else {
                statusElement.innerHTML = '<p style="color: red;">Status: Terputus</p>';
            }
        }

        async function checkNodeStatus(url, statusDot) {
            try {
                const response = await fetch(`${url}/ping`);
                statusDot.classList.toggle('online', response.ok);
                statusDot.classList.toggle('offline', !response.ok);
            } catch {
                statusDot.classList.add('offline');
            }
        }

        // Update status on connect/disconnect events
        socket.on('connect', updateConnectionStatus);
        socket.on('disconnect', updateConnectionStatus);

        // Initial status update
        document.addEventListener('DOMContentLoaded', updateConnectionStatus);

        // Update daftar node
        function updateNodeList(nodes) {
            const container = document.getElementById('nodes');
            container.innerHTML = '';

            nodes.forEach(node => {
                const nodeEl = document.createElement('div');
                nodeEl.className = 'node-item';
                nodeEl.innerHTML = `
                    <div>${node}</div>
                    <div>${node === currentNode ? '(Current)' : ''}</div>
                `;
                container.appendChild(nodeEl);
            });
        }

        // Dapatkan info node saat pertama load
        fetch('/api/nodes')
            .then(res => res.json())
            .then(data => {
                currentNode = data.currentNode;
                updateNodeList(data.nodes);
            });

        // Daftarkan node baru
        // Di network.html - Tambahkan validasi:
        function registerNode() {
            const nodeUrl = document.getElementById('nodeUrl').value.trim();

            // Validasi format URL
            if (!/^https?:\/\//.test(nodeUrl)) {
                showErrorToast('Format URL tidak valid! Contoh: http://192.168.1.2:3000');
                return;
            }

            socket.emit('register-node', { nodeUrl });
        }

        socket.on('network_update', (nodes) => {
            const nodesContainer = document.getElementById('nodes');
            nodesContainer.innerHTML = '';

            nodes.forEach(url => {
                const nodeEl = document.createElement('div');
                nodeEl.className = 'node-item';
                nodeEl.innerHTML = `
      <span class="node-url">${url}</span>
      <span class="status-dot"></span>
    `;
                nodesContainer.appendChild(nodeEl);

                checkNodeStatus(url, nodeEl.querySelector('.status-dot'));
            });
        });
    </script>
</body>

</html>